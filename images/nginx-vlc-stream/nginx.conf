user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Optimizations for video streaming
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    # Allow large files
    client_max_body_size 0;

    # Disable buffering for streaming
    proxy_buffering off;

    server {
        listen 8080;
        server_name _;

        # Root directory where videos are stored
        root /media;

        # Enable directory listing for browsing
        autoindex on;
        autoindex_exact_size off;  # Show human-readable file sizes
        autoindex_localtime on;     # Show local time instead of GMT

        location / {
            # Add CORS headers for browser access (optional)
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, HEAD, OPTIONS';
            add_header Access-Control-Allow-Headers 'Range';
            add_header Access-Control-Expose-Headers 'Content-Length, Content-Range';

            # Cache static content headers
            add_header Cache-Control "public, max-age=3600";

            # Enable range requests (for seeking in videos) - nginx does this by default
            # but we make it explicit
            add_header Accept-Ranges bytes;

            # Handle OPTIONS requests for CORS preflight
            if ($request_method = 'OPTIONS') {
                return 204;
            }

            # Try to serve file directly
            try_files $uri $uri/ =404;
        }

        # Specific location for common video formats
        location ~* \.(mp4|mkv|avi|mov|wmv|flv|webm|m4v|mpg|mpeg|3gp)$ {
            add_header Access-Control-Allow-Origin *;
            add_header Accept-Ranges bytes;
            add_header Cache-Control "public, max-age=3600";

            # Ensure proper MIME type
            types {
                video/mp4 mp4 m4v;
                video/x-matroska mkv;
                video/x-msvideo avi;
                video/quicktime mov;
                video/x-ms-wmv wmv;
                video/x-flv flv;
                video/webm webm;
                video/mpeg mpg mpeg;
                video/3gpp 3gp;
            }
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
    }
}
